<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
          "DTD/xhtml1-strict.dtd">
<html>
  <head>
    <title>msiempy.__init__ : API documentation</title>

    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="apidocs.css" />
  </head>
  <body>

    <nav class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="index.html">
            msiempy API Documentation
          </a>
        </div>
      </div>
    </nav>

    <div id="showPrivate">
      <button class="btn btn-link" onclick="togglePrivate()">Toggle Private API</button>
    </div>

    <div class="container">

      <div class="page-header">
        <h1 class="module"><code>msiempy.__init__</code> <small>module documentation</small></h1>

        <span id="partOf">
          Part of <code><a href="msiempy.html" class="code" data-type="Package">msiempy</a></code>
          <a href="https://github.com/mfesiem/msiempy/blob/master//msiempy/__init__.py">View Source</a>
          
        </span>
      </div>

      <div class="extrasDocstring">
        
      </div>

      <div class="moduleDocstring">
        <div><p class="pre">**The pythonic way to deal with the McAfee SIEM API**.  

Looking for a CLI tool? Checkout the msiem CLI https://github.com/mfesiem/msiem  

Already know what you're looking for? Checkout the Class Hierarchy.    

Quick links: 
- GitHub&lt;https://github.com/mfesiem/msiempy&gt;, 
- PyPI&lt;https://pypi.org/project/msiempy/&gt;, 
- Class diagram&lt;https://mfesiem.github.io/docs/msiempy/classes.png&gt;, 
- Packages diagram&lt;https://mfesiem.github.io/docs/msiempy/packages.png&gt;,
- other SIEM API references&lt;https://mfesiem.github.io&gt; (generated PDFs and other links)  

Installation
============
Run

        python3 -m pip install msiempy

Authentication and configuration setup
======================================

The module offers a single point of authentication against your SIEM, so you don't have to worry about authentication when writting your scripts. This means that you need to preconfigure the authentication using the configuration file.

The configuration file is located (by default) securely in your user directory since it contains credentials.  

        - For Windows:  ``%APPDATA%\.msiem\conf.ini``
        - For Mac :     ``$HOME/.msiem/conf.ini``  
        - For Linux :   ``$XDG_CONFIG_HOME/.msiem/conf.ini`` or ``$HOME/.msiem/conf.ini``

Exemple

        [esm]
        host = HOST
        user = USER
        passwd = PASSWORD's BASE64
        [general]
        verbose = no
        quiet = no
        logfile = /home/user/.msiem/log.txt
        timeout = 60
        ssl_verify = no


To set the password, you can use the ``msiempy_setup.py``&lt;https://github.com/mfesiem/msiempy/blob/master/samples/msiempy_setup.py&gt; script.  
You can also directly paste the password's base64 in the config file by doing:  

&gt;&gt;&gt; import base64
&gt;&gt;&gt; passwd = 'P@assW0rd'
&gt;&gt;&gt; print(base64.b64encode(passwd.encode('utf-8')).decode())
UEBhc3NXMHJk

A few usage exemples
====================

        See also: 
                The samples folder&lt;https://github.com/mfesiem/msiempy/tree/master/samples&gt; for more, and/or review the tests&lt;https://github.com/mfesiem/msiempy/tree/master/tests&gt;.     

        Execute an event query 
        ----------------------

        Query events according to destination IP and hostname filters, sorted by AlertID.  

        &gt;&gt;&gt; from  msiempy import EventManager, FieldFilter
        &gt;&gt;&gt; print('Simple event query sorted by AlertID')
        &gt;&gt;&gt; events = EventManager(
                time_range='CURRENT_YEAR',
                fields=['SrcIP', 'AlertID'], # SrcIP and AlertID are not queried by default
                filters=[
                        FieldFilter('DstIP', ['0.0.0.0/0',]),
                        FieldFilter('HostID', ['mail'], operator='CONTAINS')], # Replace "mail" by a test hostname
                order=(('ASCENDING', 'AlertID')),
                limit=10) # Will only load 10 events (per query)
        &gt;&gt;&gt; events.load_data()
        &gt;&gt;&gt; print(events)
        &gt;&gt;&gt; print(events.get_text(fields=['AlertID','LastTime','SrcIP', 'Rule.msg']))
        
        Notes: 
                - The ``limit`` argument should be increased to 500 or 1000 once finish testing for better performance.  
                - Dump full list of fields usable in query `msiempy.event.FieldFilter` with dump_all_fields.py&lt;https://github.com/mfesiem/msiempy/blob/master/samples/dump_all_fields.py&gt; script.  
        
        See: 
                Objects `msiempy.event.EventManager` and `msiempy.event.FieldFilter`
        
        Acknowledge alarms
        ------------------

        Print all ``unacknowledged`` alarms filtered by alarm name and event message
        
        match} ``'Test alarm'`` and triggering event message match ``'Wordpress'``.  
        Then acknowledge the alarms.  

        &gt;&gt;&gt; from msiempy import AlarmManager, Alarm
        # Make an alarm query
        &gt;&gt;&gt; alarms=AlarmManager(
                time_range='CURRENT_YEAR',
                status_filter='unacknowledged', # passed to alarmGetTriggeredAlarms
                filters=[('alarmName', 'Test alarm')], # Regex  
                event_filters=[('ruleName','Wordpress')], # Regex  
                page_size=5 # Will only load 5 alarms (per page)  
        ) 
        # Load the data into the list
        &gt;&gt;&gt; alarms.load_data() 
        # Print results
        &gt;&gt;&gt; print("Alarm list: ")
        &gt;&gt;&gt; print(alarms)
        &gt;&gt;&gt; print(alarms.get_text(
                fields=['id','triggeredDate','acknowledgedDate', 'alarmName', 'acknowledgedUsername']))
        # Acknowledge alarms
        &gt;&gt;&gt; print("Acknowledge alarms")
        &gt;&gt;&gt; for alarm in alarms:
                alarm.acknowledge()
        
        Notes: 
                - The ``page_size`` argument should be increased to 500 or 1000 once finish testing for better performance.  

                - The `msiempy.alarm.AlarmManager` filtering feature is an addon to what the SIEM API offers, filters are applied locally as regular expressions.  

        See: 
                Objects `msiempy.alarm.AlarmManager` and `msiempy.alarm.Alarm`
        
        Make direct API calls
        ---------------------

        This is useful when dealing with features of the ESM API that are not explicitly implemented in this library yet (i.e. user managment).  

        **Use the session object** to make direct API calls with any data. 

        &gt;&gt;&gt; from msiempy import NitroSession
        &gt;&gt;&gt; s = NitroSession()
        &gt;&gt;&gt; s.login()
        # Get all last 24h alarms details with ESM API v2 (not supported yet)  
        &gt;&gt;&gt; alarms = s.api_request('v2/alarmGetTriggeredAlarms?triggeredTimeRange=LAST_24_HOURS&amp;status=&amp;pageSize=500&amp;pageNumber=1')
        &gt;&gt;&gt; for a in alarms:
                a.update(s.api_request('v2/notifyGetTriggeredNotificationDetail', {'id':a['id']}))
        
        The session object will handle authentication and intermittent (but annoying) SIEM errors.  

        See: 
                Object `msiempy.core.session.NitroSession`

        Add a note to events
        --------------------

        Set the note of 2 events and check if the note is well set.  
        
        &gt;&gt;&gt; from  msiempy import EventManager, Event
        &gt;&gt;&gt; events = EventManager(
                time_range='CURRENT_YEAR',
                limit=2 )
        &gt;&gt;&gt; events.load_data()
        &gt;&gt;&gt; for event in events :
                event.set_note("Test note")
                event.refresh(use_query=False) # Event data will be loaded with ipsGetAlertData API method
                assert "Test note" in genuine_event['note'], "Error, the note hasn't been added"

        See: 
                - add_wpsan_note.py&lt;https://github.com/mfesiem/msiempy/blob/master/samples/add_wpsan_note.py&gt; script for more on how to add notes to event that triggered alarms.   

                - Object `msiempy.event.Event`

        Fetch ESM infos
        ---------------

        Print a few esm infos. ESM object has not state for it self, it's a simple interface to data structures / values returned by the SIEM.  
        
        &gt;&gt;&gt; from msiempy import ESM
        &gt;&gt;&gt; esm=ESM()
        &gt;&gt;&gt; esm.version()
        '11.2.1'
        &gt;&gt;&gt; esm.recs()
        [('ERC-1', 144116287587483648)]
        &gt;&gt;&gt; esm.buildstamp()
        '11.2.1 20190725050014'

        See: 
                Object `msiempy.device.ESM`

        Add a Datasource 
        ----------------

        &gt;&gt;&gt; from msiempy import DevTree
        &gt;&gt;&gt; devtree = DevTree()
        &gt;&gt;&gt; devtree.add({
                "name": "Test DS",
                "parent_id": "144116287587483648",
                "ds_ip": "10.2.2.2",
                "hostname": "testds.domain.ca",
                "type_id": "65"
        }) 
        {'value': 1385420} # Wait a bit for the request
        &gt;&gt;&gt; devtree.refresh() # Refresh the DevTree

        See: 
                Objects `msiempy.device.DevTree` and `msiempy.device.DataSource`
        
        Note: 
                `msiempy.device.DevTree.add` do not ensure the Datasource is well added, the methods returns a `dict` with the request ID fetched from the SIEM.  There is still place for improvment #82&lt;https://github.com/mfesiem/msiempy/issues/82&gt;.  

        Add values to a Watchlist
        -------------------------

        &gt;&gt;&gt; wl_list = WatchlistManager()
        &gt;&gt;&gt; wl = wl_list.search('test_Watchlist')[0]
        &gt;&gt;&gt; wl.add_values(['1.1.1.2', '2.2.2.1', '3.3.3.1'])

        See: 
                Objects `msiempy.watchlist.WatchlistManager`, `msiempy.watchlist.Watchlist`
        </p></div>
      </div>

      <div id="splitTables">
        
        

          
      </div>

      <div id="childList">

        

      </div>
      <address>
        <a href="index.html">API Documentation</a> for msiempy, generated by <a href="https://github.com/twisted/pydoctor/">pydoctor</a> at 2020-10-09 02:14:06.
      </address>

    </div>

    <script src="pydoctor.js" type="text/javascript"></script>

  </body>
</html>